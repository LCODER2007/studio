rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isRole(role) {
      return isAuthenticated() && request.auth.token.role == role;
    }

    function isOneOfRoles(roles) {
      return isAuthenticated() && request.auth.token.role in roles;
    }

    // /users/{userId}
    match /users/{userId} {
      allow read;
      allow create: if request.auth.uid == userId;
      allow update: if request.auth.uid == userId;
    }

    // /suggestions/{suggestionId}
    match /suggestions/{suggestionId} {
      allow read;
      
      // Any authenticated user can create a suggestion.
      allow create: if isAuthenticated()
                    && request.resource.data.authorUid == request.auth.uid || request.resource.data.authorUid == 'ANONYMOUS';
      
      // Only admins/super_admins can update status and scores.
      allow update: if isOneOfRoles(['ADMIN', 'SUPER_ADMIN'])
                    && request.resource.data.diff(resource.data).affectedKeys()
                       .hasOnly(['status', 'impactScore', 'feasibilityRating', 'costEffectivenessRating', 'reviewerUid', 'publicFeedback']);
                       
      // The original author can update their suggestion if it's still in 'SUBMITTED' status.
      allow update: if isAuthenticated() 
                    && resource.data.authorUid == request.auth.uid 
                    && resource.data.status == 'SUBMITTED'
                    && request.resource.data.diff(resource.data).affectedKeys()
                       .hasOnly(['title', 'body', 'category']);
                       
      // Disallow changing immutable fields during any update.
      allow update: if request.resource.data.suggestionId == resource.data.suggestionId
                    && request.resource.data.submissionTimestamp == resource.data.submissionTimestamp;
    }
    
    // /votes/{voteId}
    match /votes/{voteId} {
      allow read;

      // A user can only create a vote for themselves.
      // Unique votes should be enforced by using a document ID like {suggestionId}_{voterUid} in the client.
      allow create: if isAuthenticated() && request.resource.data.voterUid == request.auth.uid;
      
      // Votes are immutable.
      allow update, delete: if false;
    }
    
    // /comments/{commentId}
    match /comments/{commentId} {
      allow read;
      
      // A user can only create a comment for themselves.
      allow create: if isAuthenticated() && request.resource.data.authorUid == request.auth.uid;
      
      // Only the author of a comment can update or delete it.
      allow update, delete: if isAuthenticated() && resource.data.authorUid == request.auth.uid;
    }
  }
}
