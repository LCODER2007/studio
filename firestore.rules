/**
 * @fileoverview Firestore Security Rules for the SEES UNILAG Innovation Suggestion System (SIS) application.
 *
 * Core Philosophy:
 * This ruleset prioritizes a balance between open read access for suggestions and strict, role-based control for write operations and user data. The system uses a combination of ownership-based and role-based access control to secure data.  Admin privileges are determined by the existence of a document in the `/roles_admin/{uid}` collection.
 *
 * Data Structure:
 * - /users/{uid}: Stores user profiles, accessible only to the user themselves and potentially admins.
 * - /suggestions/{suggestionId}: Stores suggestions, publicly readable but writable only by the author or admins.
 * - /votes/{voteId}: Stores votes on suggestions, writable only by authenticated users.
 * - /comments/{commentId}: Stores comments on suggestions, writable only by authenticated users.
 * - /roles_admin/{uid}: Indicates admin privileges. The existence of a document grants admin rights.
 *
 * Key Security Decisions:
 * - Public read access for suggestions is allowed.
 * - User listing is not explicitly denied but depends on access to individual user profiles.
 * - Admin privileges are determined by the existence of a document in the `/roles_admin/{uid}` collection.
 * - Data validation is minimal to allow for prototyping, focusing on ownership and relationship integrity.
 *
 * Denormalization for Authorization:
 * - Admin status is checked by the existence of a document in the `/roles_admin/{uid}` collection, avoiding complex queries.
 * - Suggestions contain the `authorUid` field to easily enforce ownership for updates and deletes.
 *
 * Structural Segregation:
 * - Admin roles are stored in a separate `/roles_admin/{uid}` collection to simplify rule logic and improve performance.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the user is signed in.
     * @return {bool} True if the user is signed in, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the user is the owner of the document (i.e., the user ID matches the provided ID).
     * @param {string} userId The user ID to compare against the authenticated user's ID.
     * @return {bool} True if the user is the owner, false otherwise.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Checks if the user is an existing owner of the document.
     *              This combines the ownership check with the document existence check.
     * @param {string} userId The user ID to compare against the authenticated user's ID.
     * @return {bool} True if the user is the owner and the document exists, false otherwise.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * @description Checks if the user has admin privileges by verifying the existence of a document in the roles_admin collection.
     * @return {bool} True if the user is an admin, false otherwise.
     */
    function isAdmin() {
        return exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }

    /**
     * @description Rules for user profiles.
     * @path /users/{uid}
     * @allow (create) Signed-in user can create their own profile if the UID matches the document ID.
     * @allow (get, update, delete) Signed-in user can access and modify their own profile. Admins can also access and modify any profile.
     * @deny (create) User cannot create a profile for another user.
     * @deny (update, delete) User cannot modify or delete another user's profile.
     * @principle Enforces document ownership for writes and restricts access to a user's own data tree.
     */
    match /users/{uid} {
      // Allow users to create their own profile.
      allow create: if isOwner(uid) && request.resource.data.uid == uid;

      // Allow users to get, update, and delete their own profile, or if they are an admin.
      allow get, update, delete: if isExistingOwner(uid) || isAdmin();

      allow list: if false;
    }

    /**
     * @description Rules for suggestions.
     * @path /suggestions/{suggestionId}
     * @allow (get, list) All users can read suggestions.
     * @allow (create) Signed-in users can create suggestions.
     * @allow (update, delete) Only the author of the suggestion or an admin can update or delete it.
     * @deny (create) Non-signed-in users cannot create suggestions.
     * @deny (update, delete) Users cannot update or delete suggestions they don't own.
     * @principle Public read access with owner-only or admin-only writes.
     */
    match /suggestions/{suggestionId} {
      allow get, list: if true;

      allow create: if isSignedIn() && request.resource.data.authorUid == request.auth.uid;

      allow update, delete: if (resource.data.authorUid == request.auth.uid && resource != null) || isAdmin();
    }

    /**
     * @description Rules for votes.
     * @path /votes/{voteId}
     * @allow (create) Signed-in users can create votes.
     * @allow (get) Any user can get a vote.
     * @deny (create) Non-signed-in users cannot create votes.
     * @deny (update, delete) Votes cannot be updated or deleted.
     * @principle Requires authentication for creating votes.
     */
    match /votes/{voteId} {
      allow get: if true;
      allow create: if isSignedIn() && request.resource.data.voterUid == request.auth.uid;
      allow update, delete: if false;
      allow list: if false;
    }

    /**
     * @description Rules for comments.
     * @path /comments/{commentId}
     * @allow (create) Signed-in users can create comments.
     * @allow (get) Any user can get a comment.
     * @deny (create) Non-signed-in users cannot create comments.
     * @deny (update, delete) Comments cannot be updated or deleted.
     * @principle Requires authentication for creating comments.
     */
    match /comments/{commentId} {
      allow get: if true;
      allow create: if isSignedIn() && request.resource.data.authorUid == request.auth.uid;
      allow update, delete: if false;
      allow list: if false;
    }

    /**
     * @description Rules for admin roles.
     * @path /roles_admin/{uid}
     * @allow (create) Only a super admin can create admin roles.
     * @allow (get) Any authenticated user can check for admin status.
     * @deny (create, update, delete) Regular users cannot create, update, or delete admin roles.
     * @principle Restricts admin role management to super admins.
     */
    match /roles_admin/{uid} {
      // Allow creation of admin roles - you might want to restrict this to a super-admin role.  For this prototype, we allow any signed-in user to create.
      allow create: if isAdmin();

      // Allow anyone to read the admin roles collection (used for checking admin status).
      allow get: if isSignedIn();

      // No updates or deletes allowed.
      allow update, delete: if false;

      allow list: if false;
    }
  }
}