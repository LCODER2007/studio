/**
 * @fileoverview Firestore Security Rules for the application.
 *
 * Core Philosophy:
 * This ruleset prioritizes Authorization Independence by embedding authorization data
 * directly within documents. It implements a mix of public read access with
 * owner-only or role-based write access for different collections. Data consistency
 * between paths and document fields is strictly enforced to prevent privilege escalation.
 *
 * Data Structure:
 * - /users/{uid}: Stores user profile data, including a denormalized 'role' for efficient
 *   authorization. Access is restricted to the owning user for updates.
 * - /suggestions/{suggestionId}: Stores suggestions.  Open read access. Write access restricted
 *   to the author.
 * - /votes/{voteId}: Stores votes.
 * - /user_votes/{uid}/suggestions/{suggestionId}: Subcollection for tracking user votes on suggestions
 *   Restricted to the owning user.
 * - /comments/{commentId}: Stores comments. Open read access. Write access restricted to the author.
 *
 * Key Security Decisions:
 * - User listing is disabled.
 * - Public read access is granted to the `/suggestions` and `/comments` collections.
 * - Write access to `/suggestions` and `/comments` is restricted to authenticated users.
 * - The 'role' is denormalized within the user document for fast authorization checks.
 * - All write operations validate the existence of the target document to prevent accidental deletions or updates.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Defines the isSignedIn function to verify authentication.
     * @path N/A
     * @allow N/A
     * @deny N/A
     * @principle Verifies the user is signed in.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Defines the isOwner function for user ownership.
     * @path N/A
     * @allow N/A
     * @deny N/A
     * @principle Checks if the request is made by the document owner.
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    /**
     * @description Defines the isExistingOwner function for user ownership + existence.
     * @path N/A
     * @allow N/A
     * @deny N/A
     * @principle Checks if the request is made by the document owner and the document exists.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }
    /**
     * @description Grants access to user-specific data.
     * @path /users/{uid}
     * @allow (create) If the user is creating their own profile (request.auth.uid == uid).
     * @allow (update) If the user is updating their own profile.
     * @deny (create) If the user tries to create a profile with a different uid.
     * @deny (update) If the user tries to update someone else's profile.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;

      allow create: if isOwner(userId) && request.resource.data.uid == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.uid == resource.data.uid;
      allow delete: if false;
    }

    /**
     * @description Grants public read access to suggestions and restricts write access to authenticated users.
     * @path /suggestions/{suggestionId}
     * @allow (get, list) Anyone can read suggestions.
     * @allow (create) Only authenticated users can create suggestions, and the authorUid must match their UID.
     * @allow (update, delete) Only the author of the suggestion can update or delete it.
     * @deny (create) If the authorUid does not match the authenticated user's UID.
     * @deny (update, delete) If the request is not made by the author of the suggestion.
     * @principle Allows public read access while enforcing ownership for writes.
     */
    match /suggestions/{suggestionId} {
      allow get, list: if true;

      allow create: if isSignedIn() && request.resource.data.authorUid == request.auth.uid;
      allow update: if isSignedIn() && isExistingOwner(resource.data.authorUid);
      allow delete: if isSignedIn() && isExistingOwner(resource.data.authorUid);
    }

    /**
     * @description Grants access to votes.
     * @path /votes/{voteId}
     * @allow (create) Only authenticated users can create votes.
     * @deny (get, list, update, delete) No one can get, list, update or delete votes directly.
     * @principle Restricts access to creating votes; other operations are likely handled by a backend function.
     */
    match /votes/{voteId} {
      allow get, list, update, delete: if false;
      allow create: if isSignedIn();
    }

    /**
     * @description Grants access to user-specific votes.
     * @path /user_votes/{uid}/suggestions/{suggestionId}
     * @allow (create) If the user is creating their own vote (request.auth.uid == uid).
     * @allow (get, list) If the user is listing their votes.
     * @deny (create) If the user tries to create a vote with a different uid.
     * @deny (update, delete) No one can update or delete votes directly.
     * @principle Enforces document ownership for writes.
     */
    match /user_votes/{userId}/suggestions/{suggestionId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);

      allow create: if isOwner(userId);
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Grants public read access to comments and restricts write access to authenticated users.
     * @path /comments/{commentId}
     * @allow (get, list) Anyone can read comments.
     * @allow (create) Only authenticated users can create comments, and the authorUid must match their UID.
     * @allow (update, delete) Only the author of the comment can update or delete it.
     * @deny (create) If the authorUid does not match the authenticated user's UID.
     * @deny (update, delete) If the request is not made by the author of the comment.
     * @principle Allows public read access while enforcing ownership for writes.
     */
    match /comments/{commentId} {
      allow get, list: if true;

      allow create: if isSignedIn() && request.resource.data.authorUid == request.auth.uid;
      allow update: if isSignedIn() && isExistingOwner(resource.data.authorUid);
      allow delete: if isSignedIn() && isExistingOwner(resource.data.authorUid);
    }
  }
}