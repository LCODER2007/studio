/**
 * @file Firebase Security Rules for Firestore.
 *
 * @Core Philosophy: This ruleset prioritizes secure access control based on user roles and ownership,
 * with an emphasis on protecting user data and enforcing data integrity. It avoids complex
 * hierarchical authorization dependencies by denormalizing data where necessary.
 *
 * @Data Structure:
 * - /users/{uid}: Stores user profile information, with the 'role' field used for authorization.
 * - /suggestions/{suggestionId}: Stores suggestions submitted by users, with 'authorUid' tracking ownership.
 * - /votes/{voteId}: Stores votes, linking suggestions and users.
 * - /user_votes/{uid}/suggestions/{suggestionId}:  A subcollection to track which suggestions a user has voted for.
 * - /comments/{commentId}: Stores comments on suggestions.
 *
 * @Key Security Decisions:
 * - User listing is disabled for privacy.
 * - Read access to /suggestions is public, but write access is restricted to authenticated users.
 * - Data validation is limited to authorization-critical fields to allow for flexible data shapes during prototyping.
 * - All write operations require authentication.
 *
 * @Denormalization for Authorization: The 'role' field is denormalized into the /users/{uid} document
 * to enable efficient authorization checks without additional reads.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows users to read and write their own profile data. Only the authenticated user can create their own profile.
     * @path /users/{uid}
     * @allow (create) - Authenticated user can create their own profile.
     *    - request.auth.uid: "user123"
     *    - resource.data.uid: "user123"
     * @allow (get, list, update, delete) - Authenticated user can read, update, and delete their own profile.
     *    - request.auth.uid: "user123"
     *    - resource.data.uid: "user123"
     * @deny (create) - User attempts to create a profile with a mismatched uid.
     *    - request.auth.uid: "user123"
     *    - resource.data.uid: "user456"
     * @deny (update, delete) - User attempts to update or delete another user's profile.
     *    - request.auth.uid: "user123"
     *    - resource.data.uid: "user456"
     * @principle Enforces document ownership for user profiles.
     */
    match /users/{userId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if request.auth.uid == userId;
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Allows anyone to read suggestions, but restricts writes to authenticated users, where the authorUid must match the user's ID.
     * @path /suggestions/{suggestionId}
     * @allow (get, list) - Anyone can read suggestions.
     * @allow (create) - Authenticated user can create a suggestion with their UID as the authorUid.
     *    - request.auth.uid: "user123"
     *    - resource.data.authorUid: "user123"
     * @allow (update, delete) - Authenticated user (the author) can update/delete their own suggestion.
     *    - request.auth.uid: "user123"
     *    - resource.data.authorUid: "user123"
     * @deny (create) - User attempts to create a suggestion with a mismatched authorUid.
     *    - request.auth.uid: "user123"
     *    - resource.data.authorUid: "user456"
     * @deny (update, delete) - User attempts to update or delete a suggestion they don't own.
     *    - request.auth.uid: "user123"
     *    - resource.data.authorUid: "user456"
     * @principle Allows public reads with owner-only writes; enforces ownership via authorUid.
     */
    match /suggestions/{suggestionId} {
      function isSignedIn() {
        return request.auth != null;
      }
      function isOwner(authorUid) {
        return request.auth.uid == authorUid;
      }
      function isValidSuggestionCreate() {
        return request.auth.uid == request.resource.data.authorUid;
      }
      function isExistingOwner() {
        return request.auth.uid == resource.data.authorUid;
      }
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn() && isValidSuggestionCreate();
      allow update: if isSignedIn() && isExistingOwner();
      allow delete: if isSignedIn() && isExistingOwner();
    }

    /**
     * @description Allows authenticated users to create votes, enforcing that the voterUid matches their UID.
     * @path /votes/{voteId}
     * @allow (create) - Authenticated user can create a vote with their UID as the voterUid.
     *    - request.auth.uid: "user123"
     *    - resource.data.voterUid: "user123"
     * @allow (get) - Allows any user to read a vote
     * @deny (create) - User attempts to create a vote with a mismatched voterUid.
     *    - request.auth.uid: "user123"
     *    - resource.data.voterUid: "user456"
     * @deny (update, delete) - Only creation of vote documents is allowed
     * @principle Enforces ownership via voterUid; restricts updates/deletes.
     */
    match /votes/{voteId} {
      function isSignedIn() {
        return request.auth != null;
      }
      function isOwner(voterUid) {
        return request.auth.uid == voterUid;
      }
      function isValidVoteCreate() {
        return request.auth.uid == request.resource.data.voterUid;
      }
      allow get: if true;
      allow list: if false;
      allow create: if isSignedIn() && isValidVoteCreate();
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows authenticated users to create a document in their user votes collection.
     * @path /user_votes/{uid}/suggestions/{suggestionId}
     * @allow (create) - Authenticated user can create a vote suggestion reference, where the uid matches the request and the document doesn't already exist.
     *    - request.auth.uid: "user123"
     *    - uid: "user123"
     * @allow (get, list) - Authenticated user can read their own vote suggestions.
     *    - request.auth.uid: "user123"
     *    - uid: "user123"
     * @deny (create) - User attempts to create a vote suggestion reference for another user.
     *    - request.auth.uid: "user123"
     *    - uid: "user456"
     * @deny (update, delete) - Updating or deleting vote suggestion reference documents is forbidden.
     * @principle Enforces ownership in user subcollections; limits data manipulation to creation.
     */
    match /user_votes/{userId}/suggestions/{suggestionId} {
        function isOwner(userId) {
            return request.auth.uid == userId;
        }

        allow get: if isOwner(userId);
        allow list: if isOwner(userId);
        allow create: if request.auth.uid == userId;
        allow update: if false;
        allow delete: if false;
    }

    /**
     * @description Allows authenticated users to create comments on suggestions, linking the comment to their user ID.
     * @path /comments/{commentId}
     * @allow (create) - Authenticated user can create a comment with their UID as the authorUid.
     *    - request.auth.uid: "user123"
     *    - resource.data.authorUid: "user123"
     * @allow (get, list) - Anyone can read and list comments.
     * @deny (create) - User attempts to create a comment with a mismatched authorUid.
     *    - request.auth.uid: "user123"
     *    - resource.data.authorUid: "user456"
     * @deny (update, delete) - Updating or deleting comments is forbidden.
     * @principle Enforces ownership on creation; allows public reads; restricts updates/deletes.
     */
    match /comments/{commentId} {
      function isSignedIn() {
        return request.auth != null;
      }
      function isOwner(authorUid) {
        return request.auth.uid == authorUid;
      }
      function isValidCommentCreate() {
        return request.auth.uid == request.resource.data.authorUid;
      }
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn() && isValidCommentCreate();
      allow update: if false;
      allow delete: if false;
    }
  }
}